import { __decorate, __param } from "tslib";
import Dropzone from 'dropzone';
import { PLATFORM_ID } from '@angular/core';
import { isPlatformBrowser } from '@angular/common';
import { NgZone, Inject, Optional, ElementRef, Renderer2, Directive, OnInit, OnDestroy, DoCheck, OnChanges, Input, Output, EventEmitter, SimpleChanges, KeyValueDiffer, KeyValueDiffers } from '@angular/core';
import { DROPZONE_CONFIG, DropzoneConfig, DropzoneEvents } from './dropzone.interfaces';
let DropzoneDirective = class DropzoneDirective {
    constructor(zone, renderer, elementRef, differs, platformId, defaults) {
        this.zone = zone;
        this.renderer = renderer;
        this.elementRef = elementRef;
        this.differs = differs;
        this.platformId = platformId;
        this.defaults = defaults;
        this.configDiff = null;
        this.disabled = false;
        this.DZ_INIT = new EventEmitter();
        this.DZ_ERROR = new EventEmitter();
        this.DZ_SUCCESS = new EventEmitter();
        this.DZ_SENDING = new EventEmitter();
        this.DZ_CANCELED = new EventEmitter();
        this.DZ_COMPLETE = new EventEmitter();
        this.DZ_PROCESSING = new EventEmitter();
        this.DZ_DROP = new EventEmitter();
        this.DZ_DRAGSTART = new EventEmitter();
        this.DZ_DRAGEND = new EventEmitter();
        this.DZ_DRAGENTER = new EventEmitter();
        this.DZ_DRAGOVER = new EventEmitter();
        this.DZ_DRAGLEAVE = new EventEmitter();
        this.DZ_THUMBNAIL = new EventEmitter();
        this.DZ_ADDEDFILE = new EventEmitter();
        this.DZ_REMOVEDFILE = new EventEmitter();
        this.DZ_UPLOADPROGRESS = new EventEmitter();
        this.DZ_MAXFILESREACHED = new EventEmitter();
        this.DZ_MAXFILESEXCEEDED = new EventEmitter();
        this.DZ_SUCCESSMULTIPLE = new EventEmitter();
        this.DZ_SENDINGMULTIPLE = new EventEmitter();
        this.DZ_CANCELEDMULTIPLE = new EventEmitter();
        this.DZ_COMPLETEMULTIPLE = new EventEmitter();
        this.DZ_PROCESSINGMULTIPLE = new EventEmitter();
        this.DZ_RESET = new EventEmitter();
        this.DZ_QUEUECOMPLETE = new EventEmitter();
        this.DZ_TOTALUPLOADPROGRESS = new EventEmitter();
        const dz = Dropzone;
        dz.autoDiscover = false;
    }
    ngOnInit() {
        if (!isPlatformBrowser(this.platformId)) {
            return;
        }
        const params = new DropzoneConfig(this.defaults);
        params.assign(this.config); // Custom configuration
        this.renderer.addClass(this.elementRef.nativeElement, (params.maxFiles === 1) ? 'dz-single' : 'dz-multiple');
        this.renderer.removeClass(this.elementRef.nativeElement, (params.maxFiles === 1) ? 'dz-multiple' : 'dz-single');
        this.zone.runOutsideAngular(() => {
            this.instance = new Dropzone(this.elementRef.nativeElement, params);
        });
        if (this.disabled) {
            this.instance.disable();
        }
        if (this.DZ_INIT.observers.length) {
            this.zone.run(() => {
                this.DZ_INIT.emit(this.instance);
            });
        }
        // Add auto reset handling for events
        this.instance.on('success', () => {
            if (params.autoReset != null) {
                setTimeout(() => this.reset(), params.autoReset);
            }
        });
        this.instance.on('error', () => {
            if (params.errorReset != null) {
                setTimeout(() => this.reset(), params.errorReset);
            }
        });
        this.instance.on('canceled', () => {
            if (params.cancelReset != null) {
                setTimeout(() => this.reset(), params.cancelReset);
            }
        });
        // Add native Dropzone event handling
        DropzoneEvents.forEach((eventName) => {
            this.instance.on(eventName.toLowerCase(), (...args) => {
                args = (args.length === 1) ? args[0] : args;
                const output = `DZ_${eventName.toUpperCase()}`;
                const emitter = this[output];
                if (emitter.observers.length > 0) {
                    this.zone.run(() => {
                        emitter.emit(args);
                    });
                }
            });
        });
        if (!this.configDiff) {
            this.configDiff = this.differs.find(this.config || {}).create();
            this.configDiff.diff(this.config || {});
        }
    }
    ngOnDestroy() {
        if (this.instance) {
            this.zone.runOutsideAngular(() => {
                this.instance.destroy();
            });
            this.instance = null;
        }
    }
    ngDoCheck() {
        if (!this.disabled && this.configDiff) {
            const changes = this.configDiff.diff(this.config || {});
            if (changes && this.instance) {
                this.ngOnDestroy();
                this.ngOnInit();
            }
        }
    }
    ngOnChanges(changes) {
        if (this.instance && changes['disabled']) {
            if (changes['disabled'].currentValue !== changes['disabled'].previousValue) {
                if (changes['disabled'].currentValue === false) {
                    this.zone.runOutsideAngular(() => {
                        this.instance.enable();
                    });
                }
                else if (changes['disabled'].currentValue === true) {
                    this.zone.runOutsideAngular(() => {
                        this.instance.disable();
                    });
                }
            }
        }
    }
    dropzone() {
        return this.instance;
    }
    reset(cancel) {
        if (this.instance) {
            this.zone.runOutsideAngular(() => {
                this.instance.removeAllFiles(cancel);
            });
        }
    }
};
DropzoneDirective.ctorParameters = () => [
    { type: NgZone },
    { type: Renderer2 },
    { type: ElementRef },
    { type: KeyValueDiffers },
    { type: Object, decorators: [{ type: Inject, args: [PLATFORM_ID,] }] },
    { type: undefined, decorators: [{ type: Optional }, { type: Inject, args: [DROPZONE_CONFIG,] }] }
];
__decorate([
    Input()
], DropzoneDirective.prototype, "disabled", void 0);
__decorate([
    Input('dropzone')
], DropzoneDirective.prototype, "config", void 0);
__decorate([
    Output('init')
], DropzoneDirective.prototype, "DZ_INIT", void 0);
__decorate([
    Output('error')
], DropzoneDirective.prototype, "DZ_ERROR", void 0);
__decorate([
    Output('success')
], DropzoneDirective.prototype, "DZ_SUCCESS", void 0);
__decorate([
    Output('sending')
], DropzoneDirective.prototype, "DZ_SENDING", void 0);
__decorate([
    Output('canceled')
], DropzoneDirective.prototype, "DZ_CANCELED", void 0);
__decorate([
    Output('complete')
], DropzoneDirective.prototype, "DZ_COMPLETE", void 0);
__decorate([
    Output('processing')
], DropzoneDirective.prototype, "DZ_PROCESSING", void 0);
__decorate([
    Output('drop')
], DropzoneDirective.prototype, "DZ_DROP", void 0);
__decorate([
    Output('dragStart')
], DropzoneDirective.prototype, "DZ_DRAGSTART", void 0);
__decorate([
    Output('dragEnd')
], DropzoneDirective.prototype, "DZ_DRAGEND", void 0);
__decorate([
    Output('dragEnter')
], DropzoneDirective.prototype, "DZ_DRAGENTER", void 0);
__decorate([
    Output('dragOver')
], DropzoneDirective.prototype, "DZ_DRAGOVER", void 0);
__decorate([
    Output('dragLeave')
], DropzoneDirective.prototype, "DZ_DRAGLEAVE", void 0);
__decorate([
    Output('thumbnail')
], DropzoneDirective.prototype, "DZ_THUMBNAIL", void 0);
__decorate([
    Output('addedFile')
], DropzoneDirective.prototype, "DZ_ADDEDFILE", void 0);
__decorate([
    Output('removedFile')
], DropzoneDirective.prototype, "DZ_REMOVEDFILE", void 0);
__decorate([
    Output('uploadProgress')
], DropzoneDirective.prototype, "DZ_UPLOADPROGRESS", void 0);
__decorate([
    Output('maxFilesReached')
], DropzoneDirective.prototype, "DZ_MAXFILESREACHED", void 0);
__decorate([
    Output('maxFilesExceeded')
], DropzoneDirective.prototype, "DZ_MAXFILESEXCEEDED", void 0);
__decorate([
    Output('successMultiple')
], DropzoneDirective.prototype, "DZ_SUCCESSMULTIPLE", void 0);
__decorate([
    Output('sendingMultiple')
], DropzoneDirective.prototype, "DZ_SENDINGMULTIPLE", void 0);
__decorate([
    Output('canceledMultiple')
], DropzoneDirective.prototype, "DZ_CANCELEDMULTIPLE", void 0);
__decorate([
    Output('completeMultiple')
], DropzoneDirective.prototype, "DZ_COMPLETEMULTIPLE", void 0);
__decorate([
    Output('processingMultiple')
], DropzoneDirective.prototype, "DZ_PROCESSINGMULTIPLE", void 0);
__decorate([
    Output('reset')
], DropzoneDirective.prototype, "DZ_RESET", void 0);
__decorate([
    Output('queueComplete')
], DropzoneDirective.prototype, "DZ_QUEUECOMPLETE", void 0);
__decorate([
    Output('totalUploadProgress')
], DropzoneDirective.prototype, "DZ_TOTALUPLOADPROGRESS", void 0);
DropzoneDirective = __decorate([
    Directive({
        selector: '[dropzone]',
        exportAs: 'ngxDropzone'
    }),
    __param(4, Inject(PLATFORM_ID)),
    __param(5, Optional()), __param(5, Inject(DROPZONE_CONFIG))
], DropzoneDirective);
export { DropzoneDirective };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZHJvcHpvbmUuZGlyZWN0aXZlLmpzIiwic291cmNlUm9vdCI6Im5nOi8vbmd4LWRyb3B6b25lLXdyYXBwZXIvIiwic291cmNlcyI6WyJsaWIvZHJvcHpvbmUuZGlyZWN0aXZlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFBQSxPQUFPLFFBQVEsTUFBTSxVQUFVLENBQUM7QUFFaEMsT0FBTyxFQUFFLFdBQVcsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUM1QyxPQUFPLEVBQUUsaUJBQWlCLEVBQUUsTUFBTSxpQkFBaUIsQ0FBQztBQUNwRCxPQUFPLEVBQUUsTUFBTSxFQUFFLE1BQU0sRUFBRSxRQUFRLEVBQUUsVUFBVSxFQUFFLFNBQVMsRUFBRSxTQUFTLEVBQ2pFLE1BQU0sRUFBRSxTQUFTLEVBQUUsT0FBTyxFQUFFLFNBQVMsRUFBRSxLQUFLLEVBQUUsTUFBTSxFQUFFLFlBQVksRUFDbEUsYUFBYSxFQUFFLGNBQWMsRUFBRSxlQUFlLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFFeEUsT0FBTyxFQUFFLGVBQWUsRUFBRSxjQUFjLEVBQ3ZCLGNBQWMsRUFBRSxNQUFNLHVCQUF1QixDQUFDO0FBTS9ELElBQWEsaUJBQWlCLEdBQTlCLE1BQWEsaUJBQWlCO0lBMEM1QixZQUFvQixJQUFZLEVBQVUsUUFBbUIsRUFBVSxVQUFzQixFQUNuRixPQUF3QixFQUErQixVQUFrQixFQUNwQyxRQUFpQztRQUY1RCxTQUFJLEdBQUosSUFBSSxDQUFRO1FBQVUsYUFBUSxHQUFSLFFBQVEsQ0FBVztRQUFVLGVBQVUsR0FBVixVQUFVLENBQVk7UUFDbkYsWUFBTyxHQUFQLE9BQU8sQ0FBaUI7UUFBK0IsZUFBVSxHQUFWLFVBQVUsQ0FBUTtRQUNwQyxhQUFRLEdBQVIsUUFBUSxDQUF5QjtRQXpDeEUsZUFBVSxHQUF1QyxJQUFJLENBQUM7UUFFckQsYUFBUSxHQUFZLEtBQUssQ0FBQztRQUlELFlBQU8sR0FBdUIsSUFBSSxZQUFZLEVBQU8sQ0FBQztRQUV0RCxhQUFRLEdBQXNCLElB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QVcsQ0FBYzt1REFBdUQ7QUFDdEQ7SUFBakMsTUFBTSxDQUFDLGFBQWEsQ0FBWTt5REFBdUQ7QUFDdEQ7SUFBakMsTUFBTSxDQUFDLGdCQUFnQixDQUFTOzREQUF1RDtBQUN0RDtJQUFqQyxNQUFNLENBQUMsaUJBQWlCLENBQVE7NkRBQXVEO0FBQ3REO0lBQWpDLE1BQU0sQ0FBQyxrQkFBa0IsQ0FBTzs4REFBdUQ7QUFFdEQ7SUFBakMsTUFBTSxDQUFDLGlCQUFpQixDQUFROzZEQUF1RDtBQUN0RDtJQUFqQyxNQUFNLENBQUMsaUJBQWlCLENBQVE7NkRBQXVEO0FBQ3REO0lBQWpDLE1BQU0sQ0FBQyxrQkFBa0IsQ0FBTzs4REFBdUQ7QUFDdEQ7SUFBakMsTUFBTSxDQUFDLGtCQUFrQixDQUFPOzhEQUF1RDtBQUN0RDtJQUFqQyxNQUFNLENBQUMsb0JBQW9CLENBQUs7Z0VBQXVEO0FBRXREO0lBQWpDLE1BQU0sQ0FBQyxPQUFPLENBQWtCO21EQUF1RDtBQUN0RDtJQUFqQyxNQUFNLENBQUMsZUFBZSxDQUFVOzJEQUF1RDtBQUN0RDtJQUFqQyxNQUFNLENBQUMscUJBQXFCLENBQUk7aUVBQXVEO0FBeEM3RSxpQkFBaUI7SUFKN0IsU0FBUyxDQUFDO1FBQ1QsUUFBUSxFQUFFLFlBQVk7UUFDdEIsUUFBUSxFQUFFLGFBQWE7S0FDeEIsQ0FBQztJQTRDcUMsV0FBQSxNQUFNLENBQUMsV0FBVyxDQUFDLENBQUE7SUFDckQsV0FBQSxRQUFRLEVBQUUsQ0FBQSxFQUFFLFdBQUEsTUFBTSxDQUFDLGVBQWUsQ0FBQyxDQUFBO0dBNUMzQixpQkFBaUIsQ0E0SzdCO1NBNUtZLGlCQUFpQiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBEcm9wem9uZSBmcm9tICdkcm9wem9uZSc7XG5cbmltcG9ydCB7IFBMQVRGT1JNX0lEIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgeyBpc1BsYXRmb3JtQnJvd3NlciB9IGZyb20gJ0Bhbmd1bGFyL2NvbW1vbic7XG5pbXBvcnQgeyBOZ1pvbmUsIEluamVjdCwgT3B0aW9uYWwsIEVsZW1lbnRSZWYsIFJlbmRlcmVyMiwgRGlyZWN0aXZlLFxuICBPbkluaXQsIE9uRGVzdHJveSwgRG9DaGVjaywgT25DaGFuZ2VzLCBJbnB1dCwgT3V0cHV0LCBFdmVudEVtaXR0ZXIsXG4gIFNpbXBsZUNoYW5nZXMsIEtleVZhbHVlRGlmZmVyLCBLZXlWYWx1ZURpZmZlcnMgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcblxuaW1wb3J0IHsgRFJPUFpPTkVfQ09ORklHLCBEcm9wem9uZUNvbmZpZywgRHJvcHpvbmVDb25maWdJbnRlcmZhY2UsXG4gIERyb3B6b25lRXZlbnQsIERyb3B6b25lRXZlbnRzIH0gZnJvbSAnLi9kcm9wem9uZS5pbnRlcmZhY2VzJztcblxuQERpcmVjdGl2ZSh7XG4gIHNlbGVjdG9yOiAnW2Ryb3B6b25lXScsXG4gIGV4cG9ydEFzOiAnbmd4RHJvcHpvbmUnXG59KVxuZXhwb3J0IGNsYXNzIERyb3B6b25lRGlyZWN0aXZlIGltcGxlbWVudHMgT25Jbml0LCBPbkRlc3Ryb3ksIERvQ2hlY2ssIE9uQ2hhbmdlcyB7XG4gIHByaXZhdGUgaW5zdGFuY2U6IGFueTtcblxuICBwcml2YXRlIGNvbmZpZ0RpZmY6IEtleVZhbHVlRGlmZmVyPHN0cmluZywgYW55PiB8IG51bGwgPSBudWxsO1xuXG4gIEBJbnB1dCgpIGRpc2FibGVkOiBib29sZWFuID0gZmFsc2U7XG5cbiAgQElucHV0KCdkcm9wem9uZScpIGNvbmZpZz86IERyb3B6b25lQ29uZmlnSW50ZXJmYWNlO1xuXG4gIEBPdXRwdXQoJ2luaXQnICAgICAgICAgICAgICAgICAgKSBEWl9JTklUICAgICAgICAgICAgICAgICAgICAgPSBuZXcgRXZlbnRFbWl0dGVyPGFueT4oKTtcblxuICBAT3V0cHV0KCdlcnJvcicgICAgICAgICAgICAgICAgICkgRFpfRVJST1IgICAgICAgICAgICAgICAgICAgID0gbmV3IEV2ZW50RW1pdHRlcjxhbnk+KCk7XG4gIEBPdXRwdXQoJ3N1Y2Nlc3MnICAgICAgICAgICAgICAgKSBEWl9TVUNDRVNTICAgICAgICAgICAgICAgICAgPSBuZXcgRXZlbnRFbWl0dGVyPGFueT4oKTtcbiAgQE91dHB1dCgnc2VuZGluZycgICAgICAgICAgICAgICApIERaX1NFTkRJTkcgICAgICAgICAgICAgICAgICA9IG5ldyBFdmVudEVtaXR0ZXI8YW55PigpO1xuICBAT3V0cHV0KCdjYW5jZWxlZCcgICAgICAgICAgICAgICkgRFpfQ0FOQ0VMRUQgICAgICAgICAgICAgICAgID0gbmV3IEV2ZW50RW1pdHRlcjxhbnk+KCk7XG4gIEBPdXRwdXQoJ2NvbXBsZXRlJyAgICAgICAgICAgICAgKSBEWl9DT01QTEVURSAgICAgICAgICAgICAgICAgPSBuZXcgRXZlbnRFbWl0dGVyPGFueT4oKTtcbiAgQE91dHB1dCgncHJvY2Vzc2luZycgICAgICAgICAgICApIERaX1BST0NFU1NJTkcgICAgICAgICAgICAgICA9IG5ldyBFdmVudEVtaXR0ZXI8YW55PigpO1xuXG4gIEBPdXRwdXQoJ2Ryb3AnICAgICAgICAgICAgICAgICAgKSBEWl9EUk9QICAgICAgICAgICAgICAgICAgICAgPSBuZXcgRXZlbnRFbWl0dGVyPGFueT4oKTtcbiAgQE91dHB1dCgnZHJhZ1N0YXJ0JyAgICAgICAgICAgICApIERaX0RSQUdTVEFSVCAgICAgICAgICAgICAgICA9IG5ldyBFdmVudEVtaXR0ZXI8YW55PigpO1xuICBAT3V0cHV0KCdkcmFnRW5kJyAgICAgICAgICAgICAgICkgRFpfRFJBR0VORCAgICAgICAgICAgICAgICAgID0gbmV3IEV2ZW50RW1pdHRlcjxhbnk+KCk7XG4gIEBPdXRwdXQoJ2RyYWdFbnRlcicgICAgICAgICAgICAgKSBEWl9EUkFHRU5URVIgICAgICAgICAgICAgICAgPSBuZXcgRXZlbnRFbWl0dGVyPGFueT4oKTtcbiAgQE91dHB1dCgnZHJhZ092ZXInICAgICAgICAgICAgICApIERaX0RSQUdPVkVSICAgICAgICAgICAgICAgICA9IG5ldyBFdmVudEVtaXR0ZXI8YW55PigpO1xuICBAT3V0cHV0KCdkcmFnTGVhdmUnICAgICAgICAgICAgICkgRFpfRFJBR0xFQVZFICAgICAgICAgICAgICAgID0gbmV3IEV2ZW50RW1pdHRlcjxhbnk+KCk7XG5cbiAgQE91dHB1dCgndGh1bWJuYWlsJyAgICAgICAgICAgICApIERaX1RIVU1CTkFJTCAgICAgICAgICAgICAgICA9IG5ldyBFdmVudEVtaXR0ZXI8YW55PigpO1xuICBAT3V0cHV0KCdhZGRlZEZpbGUnICAgICAgICAgICAgICkgRFpfQURERURGSUxFICAgICAgICAgICAgICAgID0gbmV3IEV2ZW50RW1pdHRlcjxhbnk+KCk7XG4gIEBPdXRwdXQoJ3JlbW92ZWRGaWxlJyAgICAgICAgICAgKSBEWl9SRU1PVkVERklMRSAgICAgICAgICAgICAgPSBuZXcgRXZlbnRFbWl0dGVyPGFueT4oKTtcbiAgQE91dHB1dCgndXBsb2FkUHJvZ3Jlc3MnICAgICAgICApIERaX1VQTE9BRFBST0dSRVNTICAgICAgICAgICA9IG5ldyBFdmVudEVtaXR0ZXI8YW55PigpO1xuICBAT3V0cHV0KCdtYXhGaWxlc1JlYWNoZWQnICAgICAgICkgRFpfTUFYRklMRVNSRUFDSEVEICAgICAgICAgID0gbmV3IEV2ZW50RW1pdHRlcjxhbnk+KCk7XG4gIEBPdXRwdXQoJ21heEZpbGVzRXhjZWVkZWQnICAgICAgKSBEWl9NQVhGSUxFU0VYQ0VFREVEICAgICAgICAgPSBuZXcgRXZlbnRFbWl0dGVyPGFueT4oKTtcblxuICBAT3V0cHV0KCdzdWNjZXNzTXVsdGlwbGUnICAgICAgICkgRFpfU1VDQ0VTU01VTFRJUExFICAgICAgICAgID0gbmV3IEV2ZW50RW1pdHRlcjxhbnk+KCk7XG4gIEBPdXRwdXQoJ3NlbmRpbmdNdWx0aXBsZScgICAgICAgKSBEWl9TRU5ESU5HTVVMVElQTEUgICAgICAgICAgPSBuZXcgRXZlbnRFbWl0dGVyPGFueT4oKTtcbiAgQE91dHB1dCgnY2FuY2VsZWRNdWx0aXBsZScgICAgICApIERaX0NBTkNFTEVETVVMVElQTEUgICAgICAgICA9IG5ldyBFdmVudEVtaXR0ZXI8YW55PigpO1xuICBAT3V0cHV0KCdjb21wbGV0ZU11bHRpcGxlJyAgICAgICkgRFpfQ09NUExFVEVNVUxUSVBMRSAgICAgICAgID0gbmV3IEV2ZW50RW1pdHRlcjxhbnk+KCk7XG4gIEBPdXRwdXQoJ3Byb2Nlc3NpbmdNdWx0aXBsZScgICAgKSBEWl9QUk9DRVNTSU5HTVVMVElQTEUgICAgICAgPSBuZXcgRXZlbnRFbWl0dGVyPGFueT4oKTtcblxuICBAT3V0cHV0KCdyZXNldCcgICAgICAgICAgICAgICAgICkgRFpfUkVTRVQgICAgICAgICAgICAgICAgICAgID0gbmV3IEV2ZW50RW1pdHRlcjxhbnk+KCk7XG4gIEBPdXRwdXQoJ3F1ZXVlQ29tcGxldGUnICAgICAgICAgKSBEWl9RVUVVRUNPTVBMRVRFICAgICAgICAgICAgPSBuZXcgRXZlbnRFbWl0dGVyPGFueT4oKTtcbiAgQE91dHB1dCgndG90YWxVcGxvYWRQcm9ncmVzcycgICApIERaX1RPVEFMVVBMT0FEUFJPR1JFU1MgICAgICA9IG5ldyBFdmVudEVtaXR0ZXI8YW55PigpO1xuXG4gIGNvbnN0cnVjdG9yKHByaXZhdGUgem9uZTogTmdab25lLCBwcml2YXRlIHJlbmRlcmVyOiBSZW5kZXJlcjIsIHByaXZhdGUgZWxlbWVudFJlZjogRWxlbWVudFJlZixcbiAgICBwcml2YXRlIGRpZmZlcnM6IEtleVZhbHVlRGlmZmVycywgQEluamVjdChQTEFURk9STV9JRCkgcHJpdmF0ZSBwbGF0Zm9ybUlkOiBPYmplY3QsXG4gICAgQE9wdGlvbmFsKCkgQEluamVjdChEUk9QWk9ORV9DT05GSUcpIHByaXZhdGUgZGVmYXVsdHM6IERyb3B6b25lQ29uZmlnSW50ZXJmYWNlKVxuICB7XG4gICAgY29uc3QgZHogPSBEcm9wem9uZTtcblxuICAgIGR6LmF1dG9EaXNjb3ZlciA9IGZhbHNlO1xuICB9XG5cbiAgbmdPbkluaXQoKTogdm9pZCB7XG4gICAgaWYgKCFpc1BsYXRmb3JtQnJvd3Nlcih0aGlzLnBsYXRmb3JtSWQpKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgY29uc3QgcGFyYW1zID0gbmV3IERyb3B6b25lQ29uZmlnKHRoaXMuZGVmYXVsdHMpO1xuXG4gICAgcGFyYW1zLmFzc2lnbih0aGlzLmNvbmZpZyk7IC8vIEN1c3RvbSBjb25maWd1cmF0aW9uXG5cbiAgICB0aGlzLnJlbmRlcmVyLmFkZENsYXNzKHRoaXMuZWxlbWVudFJlZi5uYXRpdmVFbGVtZW50LFxuICAgICAgKHBhcmFtcy5tYXhGaWxlcyA9PT0gMSkgPyAnZHotc2luZ2xlJyA6ICdkei1tdWx0aXBsZScpO1xuXG4gICAgdGhpcy5yZW5kZXJlci5yZW1vdmVDbGFzcyh0aGlzLmVsZW1lbnRSZWYubmF0aXZlRWxlbWVudCxcbiAgICAgIChwYXJhbXMubWF4RmlsZXMgPT09IDEpID8gJ2R6LW11bHRpcGxlJyA6ICdkei1zaW5nbGUnKTtcblxuICAgIHRoaXMuem9uZS5ydW5PdXRzaWRlQW5ndWxhcigoKSA9PiB7XG4gICAgICB0aGlzLmluc3RhbmNlID0gbmV3IERyb3B6b25lKHRoaXMuZWxlbWVudFJlZi5uYXRpdmVFbGVtZW50LCBwYXJhbXMpO1xuICAgIH0pO1xuXG4gICAgaWYgKHRoaXMuZGlzYWJsZWQpIHtcbiAgICAgIHRoaXMuaW5zdGFuY2UuZGlzYWJsZSgpO1xuICAgIH1cblxuICAgIGlmICh0aGlzLkRaX0lOSVQub2JzZXJ2ZXJzLmxlbmd0aCkge1xuICAgICAgdGhpcy56b25lLnJ1bigoKSA9PiB7XG4gICAgICAgIHRoaXMuRFpfSU5JVC5lbWl0KHRoaXMuaW5zdGFuY2UpO1xuICAgICAgfSk7XG4gICAgfVxuXG4gICAgLy8gQWRkIGF1dG8gcmVzZXQgaGFuZGxpbmcgZm9yIGV2ZW50c1xuICAgIHRoaXMuaW5zdGFuY2Uub24oJ3N1Y2Nlc3MnLCAoKSA9PiB7XG4gICAgICBpZiAocGFyYW1zLmF1dG9SZXNldCAhPSBudWxsKSB7XG4gICAgICAgIHNldFRpbWVvdXQoKCkgPT4gdGhpcy5yZXNldCgpLCBwYXJhbXMuYXV0b1Jlc2V0KTtcbiAgICAgIH1cbiAgICB9KTtcblxuICAgIHRoaXMuaW5zdGFuY2Uub24oJ2Vycm9yJywgKCkgPT4ge1xuICAgICAgaWYgKHBhcmFtcy5lcnJvclJlc2V0ICE9IG51bGwpIHtcbiAgICAgICAgc2V0VGltZW91dCgoKSA9PiB0aGlzLnJlc2V0KCksIHBhcmFtcy5lcnJvclJlc2V0KTtcbiAgICAgIH1cbiAgICB9KTtcblxuICAgIHRoaXMuaW5zdGFuY2Uub24oJ2NhbmNlbGVkJywgKCkgPT4ge1xuICAgICAgaWYgKHBhcmFtcy5jYW5jZWxSZXNldCAhPSBudWxsKSB7XG4gICAgICAgIHNldFRpbWVvdXQoKCkgPT4gdGhpcy5yZXNldCgpLCBwYXJhbXMuY2FuY2VsUmVzZXQpO1xuICAgICAgfVxuICAgIH0pO1xuXG4gICAgLy8gQWRkIG5hdGl2ZSBEcm9wem9uZSBldmVudCBoYW5kbGluZ1xuICAgIERyb3B6b25lRXZlbnRzLmZvckVhY2goKGV2ZW50TmFtZTogRHJvcHpvbmVFdmVudCkgPT4ge1xuICAgICAgdGhpcy5pbnN0YW5jZS5vbihldmVudE5hbWUudG9Mb3dlckNhc2UoKSwgKC4uLmFyZ3M6IGFueVtdKSA9PiB7XG4gICAgICAgIGFyZ3MgPSAoYXJncy5sZW5ndGggPT09IDEpID8gYXJnc1swXSA6IGFyZ3M7XG5cbiAgICAgICAgY29uc3Qgb3V0cHV0ID0gYERaXyR7ZXZlbnROYW1lLnRvVXBwZXJDYXNlKCl9YDtcblxuICAgICAgICBjb25zdCBlbWl0dGVyID0gdGhpc1tvdXRwdXQgYXMga2V5b2YgRHJvcHpvbmVEaXJlY3RpdmVdIGFzIEV2ZW50RW1pdHRlcjxhbnk+O1xuXG4gICAgICAgIGlmIChlbWl0dGVyLm9ic2VydmVycy5sZW5ndGggPiAwKSB7XG4gICAgICAgICAgdGhpcy56b25lLnJ1bigoKSA9PiB7XG4gICAgICAgICAgICBlbWl0dGVyLmVtaXQoYXJncyk7XG4gICAgICAgICAgfSk7XG4gICAgICAgIH1cbiAgICAgIH0pO1xuICAgIH0pO1xuXG4gICAgaWYgKCF0aGlzLmNvbmZpZ0RpZmYpIHtcbiAgICAgIHRoaXMuY29uZmlnRGlmZiA9IHRoaXMuZGlmZmVycy5maW5kKHRoaXMuY29uZmlnIHx8IHt9KS5jcmVhdGUoKTtcblxuICAgICAgdGhpcy5jb25maWdEaWZmLmRpZmYodGhpcy5jb25maWcgfHwge30pO1xuICAgIH1cbiAgfVxuXG4gIG5nT25EZXN0cm95KCk6IHZvaWQge1xuICAgIGlmICh0aGlzLmluc3RhbmNlKSB7XG4gICAgICB0aGlzLnpvbmUucnVuT3V0c2lkZUFuZ3VsYXIoKCkgPT4ge1xuICAgICAgICB0aGlzLmluc3RhbmNlLmRlc3Ryb3koKTtcbiAgICAgIH0pO1xuXG4gICAgICB0aGlzLmluc3RhbmNlID0gbnVsbDtcbiAgICB9XG4gIH1cblxuICBuZ0RvQ2hlY2soKTogdm9pZCB7XG4gICAgaWYgKCF0aGlzLmRpc2FibGVkICYmIHRoaXMuY29uZmlnRGlmZikge1xuICAgICAgY29uc3QgY2hhbmdlcyA9IHRoaXMuY29uZmlnRGlmZi5kaWZmKHRoaXMuY29uZmlnIHx8IHt9KTtcblxuICAgICAgaWYgKGNoYW5nZXMgJiYgdGhpcy5pbnN0YW5jZSkge1xuICAgICAgICB0aGlzLm5nT25EZXN0cm95KCk7XG5cbiAgICAgICAgdGhpcy5uZ09uSW5pdCgpO1xuICAgICAgfVxuICAgIH1cbiAgfVxuXG4gIG5nT25DaGFuZ2VzKGNoYW5nZXM6IFNpbXBsZUNoYW5nZXMpOiB2b2lkIHtcbiAgICBpZiAodGhpcy5pbnN0YW5jZSAmJiBjaGFuZ2VzWydkaXNhYmxlZCddKSB7XG4gICAgICBpZiAoY2hhbmdlc1snZGlzYWJsZWQnXS5jdXJyZW50VmFsdWUgIT09IGNoYW5nZXNbJ2Rpc2FibGVkJ10ucHJldmlvdXNWYWx1ZSkge1xuICAgICAgICBpZiAoY2hhbmdlc1snZGlzYWJsZWQnXS5jdXJyZW50VmFsdWUgPT09IGZhbHNlKSB7XG4gICAgICAgICAgdGhpcy56b25lLnJ1bk91dHNpZGVBbmd1bGFyKCgpID0+IHtcbiAgICAgICAgICAgIHRoaXMuaW5zdGFuY2UuZW5hYmxlKCk7XG4gICAgICAgICAgfSk7XG4gICAgICAgIH0gZWxzZSBpZiAoY2hhbmdlc1snZGlzYWJsZWQnXS5jdXJyZW50VmFsdWUgPT09IHRydWUpIHtcbiAgICAgICAgICB0aGlzLnpvbmUucnVuT3V0c2lkZUFuZ3VsYXIoKCkgPT4ge1xuICAgICAgICAgICAgdGhpcy5pbnN0YW5jZS5kaXNhYmxlKCk7XG4gICAgICAgICAgfSk7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9XG4gIH1cblxuICBwdWJsaWMgZHJvcHpvbmUoKTogYW55IHtcbiAgICByZXR1cm4gdGhpcy5pbnN0YW5jZTtcbiAgfVxuXG4gIHB1YmxpYyByZXNldChjYW5jZWw/OiBib29sZWFuKTogdm9pZCB7XG4gICAgaWYgKHRoaXMuaW5zdGFuY2UpIHtcbiAgICAgIHRoaXMuem9uZS5ydW5PdXRzaWRlQW5ndWxhcigoKSA9PiB7XG4gICAgICAgIHRoaXMuaW5zdGFuY2UucmVtb3ZlQWxsRmlsZXMoY2FuY2VsKTtcbiAgICAgIH0pO1xuICAgIH1cbiAgfVxufVxuIl19